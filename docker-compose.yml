services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"

  app:
    build: .
    image: auto-merge-webhook:dev
    environment:
      - APP_ID=${APP_ID}
      - APP_PRIVATE_KEY=/run/secrets/app_private_key.pem
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_NAMESPACE=automerge
      - REDIS_LOCK_TTL_SECONDS=60
      - REDIS_HEARTBEAT_SECONDS=15
      - GITHUB_API_URL=https://api.github.com
      - SERVICE_VERSION=dev
    ports:
      - "8080:8080"
    volumes:
      - ./private-key.pem:/run/secrets/app_private_key.pem:ro
    depends_on:
      - redis

volumes:
  redis-data:
    driver: local
